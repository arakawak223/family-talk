# Firebase ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«è¨­å®šã‚¬ã‚¤ãƒ‰

## æ¦‚è¦
ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€FamilyTalkã‚¢ãƒ—ãƒªã®Firebaseã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¾ã™ã€‚
**ã“ã‚Œã¯ã‚¢ãƒ—ãƒªã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«å¿…é ˆã®è¨­å®šã§ã™ã€‚**

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã¨ã¯ï¼Ÿ

Firebase ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã¯:
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡
- èªè¨¼ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ä¿è­·
- ä¸æ­£ãªã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²æ­¢

**é‡è¦**: ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ãªã„ã¨ã€èª°ã§ã‚‚ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã—ã¾ã„ã¾ã™ï¼

---

## ğŸ“‹ è¨­å®šæ‰‹é †

### 1. Firebase Consoleã«ã‚¢ã‚¯ã‚»ã‚¹

1. **Firebase Console ã‚’é–‹ã**
   ğŸ‘‰ https://console.firebase.google.com

2. **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠ**
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: `familytalk-bdcc7`

---

## ğŸ—„ï¸ Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

### ã‚¹ãƒ†ãƒƒãƒ—1: Firestoreã«ç§»å‹•

1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ **ã€ŒFirestore Databaseã€** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ä¸Šéƒ¨ã‚¿ãƒ–ã® **ã€Œãƒ«ãƒ¼ãƒ«ã€** ã‚’ã‚¯ãƒªãƒƒã‚¯

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ«ãƒ¼ãƒ«ã‚’æ›´æ–°

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
    match /users/{userId} {
      // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ã¿èª­ã¿æ›¸ãå¯èƒ½
      allow read, write: if request.auth != null
        && request.auth.uid == userId;
    }

    // å®¶æ—ã‚°ãƒ«ãƒ¼ãƒ—
    match /families/{familyId} {
      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã€ã‹ã¤å®¶æ—ãƒ¡ãƒ³ãƒãƒ¼ã§ã‚ã‚‹å ´åˆã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
      allow read: if request.auth != null
        && request.auth.uid in resource.data.members;

      allow create: if request.auth != null
        && request.auth.uid in request.resource.data.members;

      allow update, delete: if request.auth != null
        && request.auth.uid in resource.data.members;
    }

    // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    match /voiceMessages/{messageId} {
      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if request.auth != null;

      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆå¯èƒ½
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.senderId;

      // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿æ›´æ–°ãƒ»å‰Šé™¤å¯èƒ½
      allow update, delete: if request.auth != null
        && request.auth.uid == resource.data.senderId;
    }

    // è³ªå•ãƒ‡ãƒ¼ã‚¿
    match /questions/{questionId} {
      // å…¨ã¦ã®èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª­ã¿å–ã‚Šå¯èƒ½
      allow read: if request.auth != null;

      // ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã¯ç®¡ç†è€…ã®ã¿ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª¿æ•´ï¼‰
      allow write: if false; // ç¾åœ¨ã¯ç„¡åŠ¹åŒ–ï¼ˆç®¡ç†è€…æ©Ÿèƒ½å®Ÿè£…æ™‚ã«å¤‰æ›´ï¼‰
    }

    // å›ç­”ãƒ‡ãƒ¼ã‚¿
    match /answers/{answerId} {
      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if request.auth != null;

      // è‡ªåˆ†ã®å›ç­”ã®ã¿ä½œæˆå¯èƒ½
      allow create: if request.auth != null
        && request.auth.uid == request.resource.data.userId;

      // è‡ªåˆ†ã®å›ç­”ã®ã¿æ›´æ–°ãƒ»å‰Šé™¤å¯èƒ½
      allow update, delete: if request.auth != null
        && request.auth.uid == resource.data.userId;
    }
  }
}
```

### ã‚¹ãƒ†ãƒƒãƒ—3: å…¬é–‹

1. å³ä¸Šã® **ã€Œå…¬é–‹ã€** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ **ã€Œå…¬é–‹ã€** ã‚’ã‚¯ãƒªãƒƒã‚¯

---

## ğŸ“¦ Storage ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«

### ã‚¹ãƒ†ãƒƒãƒ—1: Storageã«ç§»å‹•

1. å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ **ã€ŒStorageã€** ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ä¸Šéƒ¨ã‚¿ãƒ–ã® **ã€Œãƒ«ãƒ¼ãƒ«ã€** ã‚’ã‚¯ãƒªãƒƒã‚¯

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ«ãƒ¼ãƒ«ã‚’æ›´æ–°

ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„:

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«
    match /voice-messages/{userId}/{allPaths=**} {
      // èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½
      allow read: if request.auth != null;

      // è‡ªåˆ†ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½
      allow write: if request.auth != null
        && request.auth.uid == userId
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™: 10MB
        && request.resource.size < 10 * 1024 * 1024
        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿è¨±å¯
        && request.resource.contentType.matches('audio/.*');
    }

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒ
    match /profile-images/{userId}/{allPaths=**} {
      // å…¨ã¦ã®èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª­ã¿å–ã‚Šå¯èƒ½
      allow read: if request.auth != null;

      // è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½
      allow write: if request.auth != null
        && request.auth.uid == userId
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™: 5MB
        && request.resource.size < 5 * 1024 * 1024
        // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿è¨±å¯
        && request.resource.contentType.matches('image/.*');
    }
  }
}
```

### ã‚¹ãƒ†ãƒƒãƒ—3: å…¬é–‹

1. å³ä¸Šã® **ã€Œå…¬é–‹ã€** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ **ã€Œå…¬é–‹ã€** ã‚’ã‚¯ãƒªãƒƒã‚¯

---

## âœ… è¨­å®šç¢ºèª

### Firestore ãƒ«ãƒ¼ãƒ«ç¢ºèª

1. Firebase Console â†’ Firestore Database â†’ ãƒ«ãƒ¼ãƒ«
2. ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª:
   ```
   ãƒ«ãƒ¼ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: rules_version = '2'
   å…¬é–‹æ—¥æ™‚: (æœ€æ–°ã®æ—¥æ™‚)
   ```

### Storage ãƒ«ãƒ¼ãƒ«ç¢ºèª

1. Firebase Console â†’ Storage â†’ ãƒ«ãƒ¼ãƒ«
2. ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª:
   ```
   ãƒ«ãƒ¼ãƒ«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: rules_version = '2'
   å…¬é–‹æ—¥æ™‚: (æœ€æ–°ã®æ—¥æ™‚)
   ```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### Firestore ãƒ«ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ

Firebase Console ã§ãƒ†ã‚¹ãƒˆã§ãã¾ã™:

1. Firestore Database â†’ ãƒ«ãƒ¼ãƒ« ã‚¿ãƒ–
2. ã€Œãƒ«ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªã‚’å®Ÿè¡Œ:

**ãƒ†ã‚¹ãƒˆ1: æœªèªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼**
```
ã‚¿ã‚¤ãƒ—: get
å ´æ‰€: /users/test123
èªè¨¼: ãªã—
çµæœ: âŒ æ‹’å¦ã•ã‚Œã‚‹ã¹ã
```

**ãƒ†ã‚¹ãƒˆ2: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ï¼‰**
```
ã‚¿ã‚¤ãƒ—: get
å ´æ‰€: /users/test123
èªè¨¼: test123
çµæœ: âœ… è¨±å¯ã•ã‚Œã‚‹ã¹ã
```

### Storage ãƒ«ãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆ

ã‚¢ãƒ—ãƒªã§å®Ÿéš›ã«ãƒ†ã‚¹ãƒˆ:
1. éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éŒ²éŸ³ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
2. ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã“ã¨ã‚’ç¢ºèª

---

## âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. èªè¨¼ã‚’å¿…é ˆã«ã™ã‚‹
```javascript
// âŒ æ‚ªã„ä¾‹
allow read, write: if true;

// âœ… è‰¯ã„ä¾‹
allow read, write: if request.auth != null;
```

### 2. æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…
```javascript
// âŒ æ‚ªã„ä¾‹
allow write: if request.auth != null;

// âœ… è‰¯ã„ä¾‹
allow write: if request.auth != null
  && request.auth.uid == resource.data.ownerId;
```

### 3. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨ã‚¿ã‚¤ãƒ—ã‚’åˆ¶é™
```javascript
// âœ… è‰¯ã„ä¾‹
allow write: if request.resource.size < 10 * 1024 * 1024
  && request.resource.contentType.matches('audio/.*');
```

### 4. ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
```javascript
// âœ… è‰¯ã„ä¾‹
allow create: if request.resource.data.keys().hasAll(['name', 'createdAt'])
  && request.resource.data.name is string;
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¨ãƒ©ãƒ¼: "Permission denied"

**åŸå› **: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ãŒå³ã—ã™ãã‚‹ã€ã¾ãŸã¯è¨­å®šãƒŸã‚¹

**è§£æ±ºæ–¹æ³•**:
1. Firebase Console â†’ Firestore/Storage â†’ ãƒ«ãƒ¼ãƒ« ã‚’ç¢ºèª
2. ãƒ«ãƒ¼ãƒ«ãŒæ­£ã—ãã‚³ãƒ”ãƒ¼ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ­£ã—ãèªè¨¼ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆ`request.auth != null`ï¼‰

---

### ã‚¨ãƒ©ãƒ¼: "Invalid argument"

**åŸå› **: ãƒ«ãƒ¼ãƒ«ã®æ§‹æ–‡ã‚¨ãƒ©ãƒ¼

**è§£æ±ºæ–¹æ³•**:
1. ãƒ«ãƒ¼ãƒ«ã‚’å†åº¦ã‚³ãƒ”ãƒ¼ï¼†ãƒšãƒ¼ã‚¹ãƒˆ
2. ã‚»ãƒŸã‚³ãƒ­ãƒ³ã‚„ã‚«ãƒƒã‚³ãŒæ­£ã—ã„ã‹ç¢ºèª
3. `rules_version = '2';` ãŒå…ˆé ­ã«ã‚ã‚‹ã‹ç¢ºèª

---

### ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼

**åŸå› **: ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¾ãŸã¯ã‚¿ã‚¤ãƒ—ã®åˆ¶é™

**è§£æ±ºæ–¹æ³•**:
1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’ç¢ºèªï¼ˆéŸ³å£°: 10MBä»¥ä¸‹ã€ç”»åƒ: 5MBä»¥ä¸‹ï¼‰
2. ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’ç¢ºèªï¼ˆéŸ³å£°: audio/*, ç”»åƒ: image/*ï¼‰
3. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ãƒ«ãƒ¼ãƒ«ã‚’èª¿æ•´

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Firebase ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://firebase.google.com/docs/rules)
- [Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰](https://firebase.google.com/docs/firestore/security/get-started)
- [Storage ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰](https://firebase.google.com/docs/storage/security)
- [ãƒ«ãƒ¼ãƒ«ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹](https://firebase.google.com/docs/rules/rules-and-auth)

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

è¨­å®šå®Œäº†å¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:

- [ ] Firestore ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®š
- [ ] Firestore ãƒ«ãƒ¼ãƒ«ã‚’å…¬é–‹
- [ ] Storage ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®š
- [ ] Storage ãƒ«ãƒ¼ãƒ«ã‚’å…¬é–‹
- [ ] ãƒ«ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆ
- [ ] ã‚¢ãƒ—ãƒªã§å‹•ä½œç¢ºèª

---

## ğŸ‰ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«è¨­å®šãŒå®Œäº†ã—ãŸã‚‰:

1. **Webã‚¢ãƒ—ãƒªã®ãƒ†ã‚¹ãƒˆ**
   - Vercel URL ã«ã‚¢ã‚¯ã‚»ã‚¹
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³
   - éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€å—ä¿¡

2. **ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã®ãƒ“ãƒ«ãƒ‰** (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
   - iOS: `IOS_BUILD_GUIDE.md`
   - Android: `ANDROID_BUILD_GUIDE.md`
